---
// Import your types and components
import type { Article } from '../schema/articleSchemas';
import WikiHomepage from '../layouts/WikiHomepage.astro';

// Initialization
let articles: Array<Article> = [];
const { searchParams } = new URL(Astro.request.url);
const query = searchParams.get('query');

// Function to fetch articles based on the query
async function getArticlesForQuery(query: string) {
    if (!query) return;
    const myHeaders = new Headers();
    myHeaders.append("Content-Type", "application/json");
    const raw = JSON.stringify({ "query": query });
    const requestOptions: RequestInit = {
        method: 'POST',
        headers: myHeaders,
        body: raw,
        redirect: 'follow'
    };
    const response = await fetch("http://localhost:4321/api/search", requestOptions);
    articles = await response.json();
}

// Execute the fetching function
await getArticlesForQuery(query);
---

<!-- Use WikiHomepage component to render the page -->
<WikiHomepage title="Search Page">
    <div class="p-4">
    {articles.length > 0 ? (
        <ul class="columns-2" id="query-results">
            {articles.map((article: Article) => (
                <li class="break-inside-avoid  mb-4" key={article.slug}><a class="h2" href={`/${article.slug}`}>{article.title}</a><p>{article.content.mainContentArray[0].text.substring(0,150)}...</p></li>
            ))}
        </ul>
    ) : (
        query ? <p>No articles found</p> : <p>Type something in the Search Field to search</p>
    )}
    </div>
</WikiHomepage>
